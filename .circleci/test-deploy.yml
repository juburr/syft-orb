version: 2.1
orbs:
  # Your orb will be automatically injected here during the pipeline.
  # Reference your orb's jobs and commands below as they will exist when built.
  orb-tools: circleci/orb-tools@12.0
  # The orb definition is intentionally not included here. It will be injected into the pipeline.
  syft-orb: {}

# Use this tag to ensure test jobs always run,
# even though the downstream publish job will only run on release tags.
filters: &filters
  tags:
    only: /.*/

# Filter for release tags.
release-filters: &release-filters
  branches:
    ignore: /.*/
  tags:
    only: /^v[0-9]+\.[0-9]+\.[0-9]+$/

jobs:
  # Create jobs to test the commands of your orbs.
  # You may want to add additional validation steps to ensure the commands are working as expected.
  command-test:
    docker:
      - image: cimg/base:current-22.04
    steps:
      - checkout
      # Run your orb's commands to validate them.
      - syft-orb/install
      - run:
          name: Verify Install
          command: command -v syft
      - run:
          name: Log Syft Version
          command: syft version

      # Test 1: Single format with auto-generated output in default directory
      - syft-orb/generate_sbom:
          source: gcr.io/distroless/static:latest
          output_formats: spdx-json
      - run:
          name: "Verify single format in default sboms/ directory"
          command: |
            EXPECTED="sboms/static-latest.spdx.json"
            if [[ ! -f "${EXPECTED}" ]]; then
              echo "ERROR: Expected auto-generated file ${EXPECTED} not found"
              echo "Contents of sboms/ directory:"
              ls -la sboms/ || echo "sboms/ directory does not exist"
              exit 1
            fi
            echo "SUCCESS: Found ${EXPECTED}"

      # Test 2: Single format with custom output directory
      - syft-orb/generate_sbom:
          source: gcr.io/distroless/static:latest
          output_dir: custom-output
          output_formats: spdx-json
      - run:
          name: "Verify single format in custom directory"
          command: |
            EXPECTED="custom-output/static-latest.spdx.json"
            if [[ ! -f "${EXPECTED}" ]]; then
              echo "ERROR: Expected auto-generated file ${EXPECTED} not found"
              echo "Contents of custom-output/ directory:"
              ls -la custom-output/ || echo "custom-output/ directory does not exist"
              exit 1
            fi
            echo "SUCCESS: Found ${EXPECTED}"

      # Test 3: Multiple formats (SPDX and CycloneDX) in single scan
      - syft-orb/generate_sbom:
          source: gcr.io/distroless/static:latest
          output_dir: multi-format-output
          output_formats: "spdx-json,cyclonedx-json"
      - run:
          name: "Verify multiple formats generated"
          command: |
            SPDX_FILE="multi-format-output/static-latest.spdx.json"
            CDX_FILE="multi-format-output/static-latest.cdx.json"

            # Check SPDX file
            if [[ ! -f "${SPDX_FILE}" ]]; then
              echo "ERROR: Expected SPDX file ${SPDX_FILE} not found"
              ls -la multi-format-output/
              exit 1
            fi
            echo "SUCCESS: Found ${SPDX_FILE}"

            # Check CycloneDX file
            if [[ ! -f "${CDX_FILE}" ]]; then
              echo "ERROR: Expected CycloneDX file ${CDX_FILE} not found"
              ls -la multi-format-output/
              exit 1
            fi
            echo "SUCCESS: Found ${CDX_FILE}"

            # Verify both are valid JSON
            python3 -c "import json; json.load(open('${SPDX_FILE}'))"
            python3 -c "import json; json.load(open('${CDX_FILE}'))"
            echo "SUCCESS: Both files are valid JSON"
      - syft-orb/log_sbom:
          pretty: true
          sbom_dir: multi-format-output

      # Test 4: Three formats in single scan
      - syft-orb/generate_sbom:
          source: gcr.io/distroless/static:latest
          output_dir: three-formats
          output_formats: "spdx-json,cyclonedx-json,syft-json"
      - run:
          name: "Verify three formats generated"
          command: |
            SPDX_FILE="three-formats/static-latest.spdx.json"
            CDX_FILE="three-formats/static-latest.cdx.json"
            SYFT_FILE="three-formats/static-latest.syft.json"

            for f in "${SPDX_FILE}" "${CDX_FILE}" "${SYFT_FILE}"; do
              if [[ ! -f "${f}" ]]; then
                echo "ERROR: Expected file ${f} not found"
                ls -la three-formats/
                exit 1
              fi
              echo "SUCCESS: Found ${f}"
            done

      # Test 5: RPM file with multiple formats
      - run:
          name: Download an RPM to test with
          command: |
            mkdir -p /tmp/rpm
            curl -L -o /tmp/rpm/syft_1.24.0_linux_amd64.rpm https://github.com/anchore/syft/releases/download/v1.24.0/syft_1.24.0_linux_amd64.rpm
      - syft-orb/generate_sbom:
          source: /tmp/rpm/syft*_linux_amd64.rpm
          output_dir: rpm-multi
          output_formats: "spdx-json,cyclonedx-json"
      - run:
          name: "Verify RPM with multiple formats"
          command: |
            SPDX_FILE="rpm-multi/syft_1.24.0_linux_amd64.spdx.json"
            CDX_FILE="rpm-multi/syft_1.24.0_linux_amd64.cdx.json"

            if [[ ! -f "${SPDX_FILE}" ]]; then
              echo "ERROR: Expected SPDX file ${SPDX_FILE} not found"
              ls -la rpm-multi/
              exit 1
            fi
            echo "SUCCESS: Found ${SPDX_FILE}"

            if [[ ! -f "${CDX_FILE}" ]]; then
              echo "ERROR: Expected CycloneDX file ${CDX_FILE} not found"
              ls -la rpm-multi/
              exit 1
            fi
            echo "SUCCESS: Found ${CDX_FILE}"

      # Test 6: Single format with trailing slash directory
      - syft-orb/generate_sbom:
          source: gcr.io/distroless/static:latest
          output_dir: trailing-slash/
          output_formats: cyclonedx-json
      - run:
          name: "Verify trailing slash directory handling"
          command: |
            EXPECTED="trailing-slash/static-latest.cdx.json"
            if [[ ! -f "${EXPECTED}" ]]; then
              echo "ERROR: Expected file ${EXPECTED} not found"
              ls -la trailing-slash/ || echo "trailing-slash/ directory does not exist"
              exit 1
            fi
            echo "SUCCESS: Found ${EXPECTED}"

      # Test 7: log_sbom command with sbom_dir parameter (directory mode)
      - syft-orb/log_sbom:
          sbom_dir: sboms
          pretty: true

  # Test RPM package handling with fictitious packages
  test-rpm-packages:
    docker:
      - image: cimg/base:current-22.04
    steps:
      - checkout
      - syft-orb/install
      - run:
          name: Install FPM and Go for package creation
          command: |
            sudo apt-get update
            sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm golang-go
            sudo gem install fpm
      - run:
          name: Create fictitious RPM packages
          command: |
            # Create package content directories
            mkdir -p /tmp/pkg-content/usr/share/myapp
            mkdir -p /tmp/pkg-content/usr/bin
            mkdir -p /tmp/pkg-content/etc/myapp

            # Create some identifiable files
            echo "MyApp Configuration File v1.0" > /tmp/pkg-content/etc/myapp/config.conf
            echo "MyApp Data File" > /tmp/pkg-content/usr/share/myapp/data.txt

            # Compile a simple Go binary that syft can catalog
            mkdir -p /tmp/go-src
            cat > /tmp/go-src/main.go \<< 'GOSRC'
            package main

            import "fmt"

            func main() {
                fmt.Println("Hello from MyApp")
            }
            GOSRC
            cd /tmp/go-src && go build -o /tmp/pkg-content/usr/bin/myapp main.go
            echo "Compiled Go binary:"
            file /tmp/pkg-content/usr/bin/myapp

            # Create output directory
            mkdir -p /tmp/rpms

            # Create RPMs for different RHEL versions
            for el_version in 7 8 9 10; do
              fpm -s dir -t rpm \
                -n myapp \
                -v "1.2.3" \
                --iteration "1.el${el_version}" \
                --architecture x86_64 \
                --description "Fictitious test application" \
                --url "https://example.com/myapp" \
                --license "MIT" \
                -C /tmp/pkg-content \
                -p "/tmp/rpms/myapp-1.2.3-1.el${el_version}.x86_64.rpm" \
                .
              echo "Created: myapp-1.2.3-1.el${el_version}.x86_64.rpm"
            done

            echo ""
            echo "Created RPMs:"
            ls -la /tmp/rpms/

      # Test el7 RPM with single format (backward compatibility)
      - syft-orb/generate_sbom:
          source: /tmp/rpms/myapp-1.2.3-1.el7.x86_64.rpm
          output_formats: spdx-json
      - run:
          name: "Verify el7 RPM: single format output and SBOM contents"
          command: |
            EXPECTED="sboms/myapp-1.2.3-1.el7.x86_64.spdx.json"
            if [[ ! -f "${EXPECTED}" ]]; then
              echo "ERROR: Expected file ${EXPECTED} not found"
              ls -la sboms/ || echo "sboms/ directory does not exist"
              exit 1
            fi
            echo "SUCCESS: Found ${EXPECTED}"

            # Verify the SBOM is valid JSON and contains expected SPDX structure
            echo ""
            echo "Validating SBOM structure..."
            if ! python3 -c "import json; json.load(open('${EXPECTED}'))"; then
              echo "ERROR: SBOM is not valid JSON"
              exit 1
            fi
            echo "  Valid JSON: YES"

            # Check for SPDX version (proves syft generated it)
            if grep -q "SPDX-2.3" "${EXPECTED}"; then
              echo "  SPDX version: 2.3"
            else
              echo "ERROR: SBOM missing SPDX version"
              exit 1
            fi

            # Check for the Go binary in the SBOM
            # Syft should detect and catalog the compiled Go binary
            if grep -q "myapp" "${EXPECTED}"; then
              echo "  Go binary cataloged: YES"
            else
              echo "  ERROR: Go binary 'myapp' not found in SBOM"
              echo "  This indicates the RPM extraction may have failed."
              echo "  SBOM contents:"
              cat "${EXPECTED}"
              exit 1
            fi
            echo "SUCCESS: SBOM contains cataloged binary from extracted RPM"

      # Test el8 RPM with multiple formats
      - syft-orb/generate_sbom:
          source: /tmp/rpms/myapp-1.2.3-1.el8.x86_64.rpm
          output_dir: rpm-sboms
          output_formats: "spdx-json,cyclonedx-json"
      - run:
          name: "Verify el8 RPM: multiple formats output"
          command: |
            SPDX_FILE="rpm-sboms/myapp-1.2.3-1.el8.x86_64.spdx.json"
            CDX_FILE="rpm-sboms/myapp-1.2.3-1.el8.x86_64.cdx.json"

            if [[ ! -f "${SPDX_FILE}" ]]; then
              echo "ERROR: Expected file ${SPDX_FILE} not found"
              ls -la rpm-sboms/ || echo "rpm-sboms/ directory does not exist"
              exit 1
            fi
            echo "SUCCESS: Found ${SPDX_FILE}"

            if [[ ! -f "${CDX_FILE}" ]]; then
              echo "ERROR: Expected file ${CDX_FILE} not found"
              ls -la rpm-sboms/
              exit 1
            fi
            echo "SUCCESS: Found ${CDX_FILE}"

            # Verify valid SBOM structures
            if python3 -c "import json; json.load(open('${SPDX_FILE}'))" && grep -q "SPDX-2.3" "${SPDX_FILE}"; then
              echo "SUCCESS: Valid SPDX SBOM generated"
            else
              echo "ERROR: Invalid SPDX SBOM"
              exit 1
            fi

            if python3 -c "import json; json.load(open('${CDX_FILE}'))" && grep -q "bomFormat" "${CDX_FILE}"; then
              echo "SUCCESS: Valid CycloneDX SBOM generated"
            else
              echo "ERROR: Invalid CycloneDX SBOM"
              exit 1
            fi

      # Test el9 RPM with wildcard source and multiple formats
      - syft-orb/generate_sbom:
          source: "/tmp/rpms/*el9*.rpm"
          output_dir: rpm-sboms
          output_formats: "spdx-json,cyclonedx-json"
      - run:
          name: "Verify el9 RPM: wildcard source expansion with multiple formats"
          command: |
            SPDX_FILE="rpm-sboms/myapp-1.2.3-1.el9.x86_64.spdx.json"
            CDX_FILE="rpm-sboms/myapp-1.2.3-1.el9.x86_64.cdx.json"

            if [[ ! -f "${SPDX_FILE}" ]]; then
              echo "ERROR: Expected file ${SPDX_FILE} not found"
              ls -la rpm-sboms/
              exit 1
            fi
            echo "SUCCESS: Found ${SPDX_FILE} (wildcard expansion worked)"

            if [[ ! -f "${CDX_FILE}" ]]; then
              echo "ERROR: Expected file ${CDX_FILE} not found"
              ls -la rpm-sboms/
              exit 1
            fi
            echo "SUCCESS: Found ${CDX_FILE} (wildcard expansion worked)"

      # Test el10 RPM with three formats
      - syft-orb/generate_sbom:
          source: /tmp/rpms/myapp-1.2.3-1.el10.x86_64.rpm
          output_dir: el10-multi
          output_formats: "spdx-json,cyclonedx-json,syft-json"
      - run:
          name: "Verify el10 RPM: three formats"
          command: |
            SPDX_FILE="el10-multi/myapp-1.2.3-1.el10.x86_64.spdx.json"
            CDX_FILE="el10-multi/myapp-1.2.3-1.el10.x86_64.cdx.json"
            SYFT_FILE="el10-multi/myapp-1.2.3-1.el10.x86_64.syft.json"

            for f in "${SPDX_FILE}" "${CDX_FILE}" "${SYFT_FILE}"; do
              if [[ ! -f "${f}" ]]; then
                echo "ERROR: Expected file ${f} not found"
                ls -la el10-multi/
                exit 1
              fi
              echo "SUCCESS: Found ${f}"
            done

  # Test DEB package handling with fictitious packages
  test-deb-packages:
    docker:
      - image: cimg/base:current-22.04
    steps:
      - checkout
      - syft-orb/install
      - run:
          name: Install FPM and Go for package creation
          command: |
            sudo apt-get update
            sudo apt-get install -y ruby ruby-dev rubygems build-essential golang-go
            sudo gem install fpm
      - run:
          name: Create fictitious DEB packages
          command: |
            # Create package content directories
            mkdir -p /tmp/pkg-content/usr/share/testpkg
            mkdir -p /tmp/pkg-content/usr/bin
            mkdir -p /tmp/pkg-content/etc/testpkg

            # Create some identifiable files
            echo "TestPkg Configuration" > /tmp/pkg-content/etc/testpkg/settings.conf
            echo "TestPkg Library Data" > /tmp/pkg-content/usr/share/testpkg/library.dat

            # Compile a simple Go binary that syft can catalog
            mkdir -p /tmp/go-src
            cat > /tmp/go-src/main.go \<< 'GOSRC'
            package main

            import "fmt"

            func main() {
                fmt.Println("Hello from TestPkg")
            }
            GOSRC
            cd /tmp/go-src && go build -o /tmp/pkg-content/usr/bin/testpkg main.go
            echo "Compiled Go binary:"
            file /tmp/pkg-content/usr/bin/testpkg

            # Create output directory
            mkdir -p /tmp/debs

            # Create DEBs for different Ubuntu versions
            for ubuntu_ver in focal jammy noble; do
              fpm -s dir -t deb \
                -n testpkg \
                -v "2.0.0" \
                --iteration "1~${ubuntu_ver}" \
                --architecture amd64 \
                --description "Fictitious test package for DEB testing" \
                --url "https://example.com/testpkg" \
                --license "Apache-2.0" \
                -C /tmp/pkg-content \
                -p "/tmp/debs/testpkg_2.0.0-1~${ubuntu_ver}_amd64.deb" \
                .
              echo "Created: testpkg_2.0.0-1~${ubuntu_ver}_amd64.deb"
            done

            echo ""
            echo "Created DEBs:"
            ls -la /tmp/debs/

      # Test focal DEB with single format (backward compatibility)
      - syft-orb/generate_sbom:
          source: /tmp/debs/testpkg_2.0.0-1~focal_amd64.deb
          output_formats: spdx-json
      - run:
          name: "Verify focal DEB: single format output and SBOM contents"
          command: |
            EXPECTED="sboms/testpkg_2.0.0-1~focal_amd64.spdx.json"
            if [[ ! -f "${EXPECTED}" ]]; then
              echo "ERROR: Expected file ${EXPECTED} not found"
              ls -la sboms/ || echo "sboms/ directory does not exist"
              exit 1
            fi
            echo "SUCCESS: Found ${EXPECTED}"

            # Verify the SBOM is valid JSON and contains expected SPDX structure
            echo ""
            echo "Validating SBOM structure..."
            if ! python3 -c "import json; json.load(open('${EXPECTED}'))"; then
              echo "ERROR: SBOM is not valid JSON"
              exit 1
            fi
            echo "  Valid JSON: YES"

            # Check for SPDX version (proves syft generated it)
            if grep -q "SPDX-2.3" "${EXPECTED}"; then
              echo "  SPDX version: 2.3"
            else
              echo "ERROR: SBOM missing SPDX version"
              exit 1
            fi

            # Check for the Go binary in the SBOM
            # Syft should detect and catalog the compiled Go binary
            if grep -q "testpkg" "${EXPECTED}"; then
              echo "  Go binary cataloged: YES"
            else
              echo "  ERROR: Go binary 'testpkg' not found in SBOM"
              echo "  This indicates the DEB extraction may have failed."
              echo "  SBOM contents:"
              cat "${EXPECTED}"
              exit 1
            fi
            echo "SUCCESS: SBOM contains cataloged binary from extracted DEB"

      # Test jammy DEB with multiple formats
      - syft-orb/generate_sbom:
          source: /tmp/debs/testpkg_2.0.0-1~jammy_amd64.deb
          output_dir: deb-sboms
          output_formats: "spdx-json,cyclonedx-json"
      - run:
          name: "Verify jammy DEB: multiple formats output"
          command: |
            SPDX_FILE="deb-sboms/testpkg_2.0.0-1~jammy_amd64.spdx.json"
            CDX_FILE="deb-sboms/testpkg_2.0.0-1~jammy_amd64.cdx.json"

            if [[ ! -f "${SPDX_FILE}" ]]; then
              echo "ERROR: Expected file ${SPDX_FILE} not found"
              ls -la deb-sboms/ || echo "deb-sboms/ directory does not exist"
              exit 1
            fi
            echo "SUCCESS: Found ${SPDX_FILE}"

            if [[ ! -f "${CDX_FILE}" ]]; then
              echo "ERROR: Expected file ${CDX_FILE} not found"
              ls -la deb-sboms/
              exit 1
            fi
            echo "SUCCESS: Found ${CDX_FILE}"

            # Verify valid SBOM structures
            if python3 -c "import json; json.load(open('${SPDX_FILE}'))" && grep -q "SPDX-2.3" "${SPDX_FILE}"; then
              echo "SUCCESS: Valid SPDX SBOM generated"
            else
              echo "ERROR: Invalid SPDX SBOM"
              exit 1
            fi

      # Test noble DEB with wildcard source and multiple formats
      - syft-orb/generate_sbom:
          source: "/tmp/debs/*noble*.deb"
          output_dir: deb-sboms
          output_formats: "spdx-json,cyclonedx-json"
      - run:
          name: "Verify noble DEB: wildcard source expansion with multiple formats"
          command: |
            SPDX_FILE="deb-sboms/testpkg_2.0.0-1~noble_amd64.spdx.json"
            CDX_FILE="deb-sboms/testpkg_2.0.0-1~noble_amd64.cdx.json"

            if [[ ! -f "${SPDX_FILE}" ]]; then
              echo "ERROR: Expected file ${SPDX_FILE} not found"
              ls -la deb-sboms/
              exit 1
            fi
            echo "SUCCESS: Found ${SPDX_FILE} (wildcard expansion worked)"

            if [[ ! -f "${CDX_FILE}" ]]; then
              echo "ERROR: Expected file ${CDX_FILE} not found"
              ls -la deb-sboms/
              exit 1
            fi
            echo "SUCCESS: Found ${CDX_FILE} (wildcard expansion worked)"

      # Test DEB with three formats
      - syft-orb/generate_sbom:
          source: /tmp/debs/testpkg_2.0.0-1~focal_amd64.deb
          output_dir: deb-three
          output_formats: "spdx-json,cyclonedx-json,syft-json"
      - run:
          name: "Verify DEB with three formats"
          command: |
            SPDX_FILE="deb-three/testpkg_2.0.0-1~focal_amd64.spdx.json"
            CDX_FILE="deb-three/testpkg_2.0.0-1~focal_amd64.cdx.json"
            SYFT_FILE="deb-three/testpkg_2.0.0-1~focal_amd64.syft.json"

            for f in "${SPDX_FILE}" "${CDX_FILE}" "${SYFT_FILE}"; do
              if [[ ! -f "${f}" ]]; then
                echo "ERROR: Expected file ${f} not found"
                ls -la deb-three/
                exit 1
              fi
              echo "SUCCESS: Found ${f}"
            done

  # Test the sbom job with RPM - uses the job directly
  test-sbom-job-rpm:
    docker:
      - image: cimg/base:current-22.04
    steps:
      - checkout
      - run:
          name: Install FPM and Go for package creation
          command: |
            sudo apt-get update
            sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm golang-go
            sudo gem install fpm
      - run:
          name: Create test RPM with Go binary
          command: |
            mkdir -p /tmp/pkg-content/usr/bin
            mkdir -p /tmp/go-src
            cat > /tmp/go-src/main.go \<< 'GOSRC'
            package main
            import "fmt"
            func main() { fmt.Println("Hello") }
            GOSRC
            (cd /tmp/go-src && go build -o /tmp/pkg-content/usr/bin/testapp main.go)

            mkdir -p workspace/rpms
            fpm -s dir -t rpm -n testapp -v "1.0.0" --iteration "1.el9" \
              --architecture x86_64 -C /tmp/pkg-content \
              -p "workspace/rpms/testapp-1.0.0-1.el9.x86_64.rpm" .

            # Also create a noarch RPM
            mkdir -p /tmp/noarch-content/etc/testapp
            echo "config=value" > /tmp/noarch-content/etc/testapp/config.conf
            fpm -s dir -t rpm -n testapp-config -v "1.0.0" --iteration "1" \
              --architecture noarch -C /tmp/noarch-content \
              -p "workspace/rpms/testapp-config-1.0.0-1.noarch.rpm" .

            echo "Created RPMs:"
            ls -la workspace/rpms/
      - persist_to_workspace:
          root: .
          paths:
            - workspace

  # Test the sbom job with DEB - uses the job directly
  test-sbom-job-deb:
    docker:
      - image: cimg/base:current-22.04
    steps:
      - checkout
      - run:
          name: Install FPM and Go for package creation
          command: |
            sudo apt-get update
            sudo apt-get install -y ruby ruby-dev rubygems build-essential golang-go
            sudo gem install fpm
      - run:
          name: Create test DEB with Go binary
          command: |
            mkdir -p /tmp/pkg-content/usr/bin
            mkdir -p /tmp/go-src
            cat > /tmp/go-src/main.go \<< 'GOSRC'
            package main
            import "fmt"
            func main() { fmt.Println("Hello from DEB") }
            GOSRC
            (cd /tmp/go-src && go build -o /tmp/pkg-content/usr/bin/debapp main.go)

            mkdir -p workspace/debs
            fpm -s dir -t deb -n debapp -v "2.5.0" --iteration "1~jammy" \
              --architecture amd64 -C /tmp/pkg-content \
              -p "workspace/debs/debapp_2.5.0-1~jammy_amd64.deb" .

            echo "Created DEBs:"
            ls -la workspace/debs/
      - persist_to_workspace:
          root: .
          paths:
            - workspace

workflows:
  test-deploy:
    jobs:
      # Make sure to include "filters: *filters" in every test job you want to run as part of your deployment.
      # Test your orb's commands in a custom job and test your orb's jobs directly as a part of this workflow.
      - command-test:
          filters: *filters
      - test-rpm-packages:
          filters: *filters
      - test-deb-packages:
          filters: *filters

      # Test the sbom job
      - test-sbom-job-rpm:
          filters: *filters

      # Test sbom job with default formats (cyclonedx-json,spdx-json)
      - syft-orb/sbom:
          name: test-sbom-rpm-x86-default-formats
          source: "workspace/rpms/testapp-*.el9.x86_64.rpm"
          output_dir: sboms-default
          attach_workspace: true
          persist_to_workspace: true
          log_sboms: true
          requires:
            - test-sbom-job-rpm
          filters: *filters

      # Test sbom job with single format
      - syft-orb/sbom:
          name: test-sbom-rpm-noarch-single-format
          source: "workspace/rpms/testapp-config-*.noarch.rpm"
          output_dir: sboms-single
          output_formats: "spdx-json"
          attach_workspace: true
          persist_to_workspace: true
          log_sboms: true
          requires:
            - test-sbom-job-rpm
          filters: *filters

      # Test sbom job with three formats
      - syft-orb/sbom:
          name: test-sbom-container-three-formats
          source: "gcr.io/distroless/static:latest"
          output_dir: sboms-container
          output_formats: "spdx-json,cyclonedx-json,syft-json"
          attach_workspace: false
          persist_to_workspace: false
          log_sboms: true
          filters: *filters

      # Test sbom job with source directory (default formats)
      - syft-orb/sbom:
          name: test-sbom-source
          source: "dir:."
          output_dir: sboms-source
          attach_workspace: false
          persist_to_workspace: false
          log_sboms: true
          filters: *filters

      # Test the sbom job with DEB package (default formats)
      - test-sbom-job-deb:
          filters: *filters
      - syft-orb/sbom:
          name: test-sbom-deb-default-formats
          source: "workspace/debs/debapp_*_amd64.deb"
          output_dir: sboms-deb
          attach_workspace: true
          persist_to_workspace: true
          log_sboms: true
          requires:
            - test-sbom-job-deb
          filters: *filters

      # The orb must be re-packed for publishing, and saved to the workspace.
      - orb-tools/pack:
          filters: *release-filters
      - orb-tools/publish:
          orb_name: juburr/syft-orb
          vcs_type: << pipeline.project.type >>
          pub_type: production
          # Ensure this job requires all test jobs and the pack job.
          requires:
            - orb-tools/pack
            - command-test
            - test-rpm-packages
            - test-deb-packages
            - test-sbom-rpm-x86-default-formats
            - test-sbom-rpm-noarch-single-format
            - test-sbom-container-three-formats
            - test-sbom-source
            - test-sbom-deb-default-formats
          context: orb-publishing
          filters: *release-filters
